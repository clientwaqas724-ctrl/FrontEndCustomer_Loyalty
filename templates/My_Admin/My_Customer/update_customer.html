{% extends 'My_Admin/base.html' %}
{% load static %}
{% block title %}Update Customer - Admin Portal{% endblock %}

{% block content %}
<div class="top-bar">
    <div class="page-title">
        <button type="button" id="sidebarCollapse" class="toggle-btn me-3">
            <i class="fas fa-bars"></i>
        </button>
        <h1>Update Customer</h1>
    </div>
    <div class="user-info">
        <div class="user-details">
            <div class="user-role">{{ user_profile.email }}</div>
            {% if user_profile.role %}
            <div class="user-role">{{ user_profile.role|title }}</div>
            {% endif %}
        </div>
        <div class="user-avatar">{{ user_profile.name|first|upper }}</div>
        <div class="user-name">{{ user_profile.name|default:"Admin" }}</div>
    </div>
</div>

<div class="container-fluid mt-4">
    <a href="{% url 'customer_list' %}" class="btn btn-secondary mb-3">
        <i class="fas fa-arrow-left"></i> Back to Customers
    </a>

    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Update Customer Details</h6>
        </div>
        <div class="card-body">
            <form method="POST" id="updateCustomerForm">
                {% csrf_token %}
                <input type="hidden" id="customer_id" value="{{ customer.id }}">

                <!-- Name -->
                <div class="form-group mb-3">
                    <label for="name">Full Name *</label>
                    <input type="text" class="form-control" id="name" name="name"
                           value="{{ customer.name }}" required>
                </div>

                <!-- Email -->
                <div class="form-group mb-3">
                    <label for="email">Email *</label>
                    <input type="email" class="form-control" id="email" name="email"
                           value="{{ customer.email }}" required>
                </div>

                <!-- Phone -->
                <div class="form-group mb-3">
                    <label for="phone">Phone *</label>
                    <input type="text" class="form-control" id="phone" name="phone"
                           value="{{ customer.phone }}" required>
                </div>

                <!-- Profile Image -->
                <div class="form-group mb-3">
                    <label for="profile_image">Profile Image URL</label>
                    <input type="text" class="form-control" id="profile_image" name="profile_image"
                           value="{{ customer.profile_image }}">
                    {% if customer.profile_image %}
                    <div class="mt-2">
                        <small class="text-muted">Current Image:</small>
                        <img src="{{ customer.profile_image }}" alt="Profile" style="max-width:100px; max-height:100px; border-radius:5px;">
                    </div>
                    {% endif %}
                </div>

                <!-- Password Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-warning">Change Password (Optional)</h6>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label for="password">New Password</label>
                            <input type="password" class="form-control" id="password" name="password" placeholder="Enter new password if you want to change">
                        </div>

                        <div class="form-group mb-3">
                            <label for="password2">Confirm New Password</label>
                            <input type="password" class="form-control" id="password2" name="password2" placeholder="Confirm new password">
                        </div>
                    </div>
                </div>

                <!-- Terms & Conditions -->
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="tc" name="tc"
                        {% if customer.tc %}checked{% endif %}>
                    <label class="form-check-label" for="tc">I agree to terms & conditions</label>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success btn-icon-split">
                        <span class="icon text-white-50"><i class="fas fa-save"></i></span>
                        <span class="text">Update Customer</span>
                    </button>
                    <a href="{% url 'customer_list' %}" class="btn btn-secondary btn-icon-split">
                        <span class="icon text-white-50"><i class="fas fa-times"></i></span>
                        <span class="text">Cancel</span>
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('updateCustomerForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const customerData = {
            id: document.getElementById('customer_id').value,
            name: document.getElementById('name').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            profile_image: document.getElementById('profile_image').value.trim(),
            tc: document.getElementById('tc').checked,
            role: 'customer'
        };

        // Optional password
        const password = document.getElementById('password').value;
        const password2 = document.getElementById('password2').value;
        if(password || password2){
            if(password === password2){
                customerData.password = password;
                customerData.password2 = password2;
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Password Mismatch',
                    text: 'Passwords do not match.'
                });
                return;
            }
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        Swal.fire({
            title: 'Confirm Update?',
            text: 'Do you want to update this customer record?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Yes, Update',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if(result.isConfirmed){
                fetch("{{ USER_UPDATE_API_URL }}", {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify(customerData)
                })
                .then(res => res.json())
                .then(data => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Updated!',
                        text: data.message || 'Customer updated successfully!'
                    }).then(()=>window.location.href="{% url 'customer_list' %}");
                })
                .catch(err=>{
                    Swal.fire({icon:'error', title:'Error', text:'Failed to update customer.'});
                });
            }
        });
    });
});
</script>
{% endblock %}
